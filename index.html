<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FunTarget - Mobile Edition</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

    <style>
        /* =========================================
           CSS STYLES - MOBILE OPTIMIZED
           ========================================= */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
            font-family: 'Segoe UI', Roboto, Arial, sans-serif; 
        }

        html, body { 
            height: 100%; 
            width: 100%;
            overflow: hidden; 
            position: fixed;
            touch-action: manipulation;
            background: black; 
            color: #fff;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
  
        /* Portrait Warning */
        .portrait-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            z-index: 99999999;
            color: #FFD700;
            text-align: center;
            padding: 20% 10%;
        }
        
        @media (orientation: portrait) {
            .game-container-wrap { display: none !important; }
            .portrait-warning { display: block !important; }
        }

        .rotate-icon {
            font-size: 60px;
            margin: 20px 0;
            display: block;
            animation: rotateAnimation 2s infinite;
        }
        
        @keyframes rotateAnimation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(90deg); }
        }

        /* NEW MOBILE SYSTEM ADAPTED */
        .game-container-wrap { 
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            background-image: url('https://uploads.onecompiler.io/445tyzay6/448n7h4a3/1000053493.jpg'); 
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 100;
            overflow: hidden;
        }

        .game-app { 
            width: 100%;
            height: 100%;
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background: rgba(0, 0, 0, 0.2); 
        }

        /* LOGIN BLOCK */
        #loginBlock {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999999;
        }

        .login-card {
            background: #111;
            padding: 20px;
            border-radius: 12px;
            width: 280px;
            text-align: center;
            border: 2px solid #FFD700;
        }
        
        #cancelSpecific { 
            background: linear-gradient(180deg, #9c2b2b, #6a1a1a); 
            position: absolute; 
            top: 200px; 
            left: 10px; 
            width: 70px; 
            height: 30px; 
            z-index: 1000; 
            font-size: 12px; 
            color: white; 
            border: none; 
            border-radius: 4px; 
        }

        #cancelAll { 
            background: linear-gradient(180deg, #223b8b, #14255a); 
            position: absolute; 
            top: 200px; 
            right: 10px; 
            width: 60px; 
            height: 30px; 
            z-index: 1000; 
            font-size: 12px; 
            color: white; 
            border: none; 
            border-radius: 4px; 
        }
        
        .top-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            padding: 10px;
            height: auto;
        }

        .panel { 
            background: rgba(0, 0, 0, 0.6); 
            border-radius: 12px; 
            padding: 5px; 
            min-width: 110px; 
            margin-bottom: 5px; 
            border: 1px solid #ffd700;
        }

        .panel h4 { font-size: 12px; text-align: center; color: #ffd700; }
        .panel .value { 
            background: linear-gradient(0deg, #fff3b1, #ffd36a); 
            color: #000; 
            padding: 2px 5px; 
            border-radius: 20px; 
            text-align: center; 
            font-weight: 700; 
            font-size: 18px; 
        }

        .chip-container { display: flex; gap: 5px; justify-content: center; }
        .chip { 
            width: 35px; height: 35px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; font-size: 10px; background: #444; border: 2px solid #fff;
        }
        .chip.active { border: 2px solid #ffd700; transform: scale(1.1); box-shadow: 0 0 10px #ffd700; }

        .wheel-wrap { width: 200px; height: 200px; position: relative; margin: 0 auto; }
        canvas#wheel { width: 100%; height: 100%; border-radius: 50%; }

        .slider-container { 
            width: 60px; height: 45px; position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); overflow: hidden; border-radius: 50%; 
            background: #FFD700; z-index: 20; border: 2px solid #ffd700;
        }
        .slides-inner { display: flex; width: 1000%; height: 100%; transition: transform 8s cubic-bezier(0.1, 0, 0.1, 1); }
        .slide-item { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .slide { width: 80%; height: 80%; object-fit: contain; }

        .bet-row { 
            display: flex; justify-content: space-around; width: 100%; 
            padding: 5px; position: absolute; bottom: 50px;
        }
        .number-box { flex: 1; text-align: center; position: relative; }
        .number-box .num { 
            width: 35px; height: 35px; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; font-weight: 800; 
            color: #1b1300; background: #FFD700; margin: 0 auto;
        }
        .number-box .bet-placed { 
            position: absolute; top: -20px; left: 50%; transform: translateX(-50%); 
            font-size: 10px; background: #000; color: #fff; padding: 1px 4px; border-radius: 4px;
        }

        .status-bar { position: absolute; bottom: 5px; width: 100%; text-align: center; font-size: 12px; padding: 5px; background: rgba(0,0,0,0.5); }
        
        #topActions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; z-index: 99999; }
        #topActions button { padding: 4px 8px; font-size: 10px; border-radius: 4px; border: none; color: #fff; background: #333; }
    </style>
</head>

<body>
    <div class="portrait-warning">
        <h2>Please Rotate Your Device</h2>
        <div class="rotate-icon">â†»</div>
        <p>This game requires landscape mode to play.</p>
    </div>
    
    <div class="game-container-wrap" id="mainGame">
        <div class="game-app">
            <div id="topActions">
                <button onclick="openSendPopup()">SEND</button>
                <button onclick="logoutUser()">LOGOUT</button>
            </div>
            
            <button id="cancelSpecific" onclick="cancelLastBet()">CANCEL</button>
            <button id="cancelAll" onclick="cancelAllBets()">CLEAR</button>

            <div class="top-row">
                <div class="left-panels">
                    <div class="panel"><h4>Coins</h4><div id="coins" class="value">0</div></div>
                    <div class="panel"><h4>Time</h4><div id="time" class="value">60</div></div>
                    <div class="chip-container">
                        <div class="chip" onclick="selectChip(1)">1</div>
                        <div class="chip" onclick="selectChip(5)">5</div>
                        <div class="chip" onclick="selectChip(10)">10</div>
                    </div>
                </div>

                <div class="center-wheel-container">
                    <div class="wheel-wrap">
                        <div class="slider-container">
                            <div class="slides-inner" id="slider">
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                                <div class="slide-item"><img class="slide" src="https://uploads.onecompiler.io/445tyzay6/448mfppru/1000053482.png"></div>
                            </div>
                        </div>
                        <canvas id="wheel" width="400" height="400"></canvas>
                    </div>
                </div>

                <div class="right-panels">
                    <div class="panel"><h4>Winner</h4><div id="winner" class="value">-</div></div>
                    <div class="panel"><h4>History</h4><div id="last10">Loading...</div></div>
                    <div class="chip-container">
                        <div class="chip" onclick="selectChip(100)">100</div>
                        <div class="chip" onclick="selectChip(500)">500</div>
                        <div class="chip" onclick="selectChip(1000)">1000</div>
                    </div>
                </div>
            </div>

            <div class="bet-row" id="betRow"></div>
            <div class="status-bar" id="gameStatus">PLEASE LOGIN FIRST</div>
        </div>
    </div>

    <div id="loginBlock">
        <div class="login-card">
            <h3>Login</h3>
            <input id="uid" placeholder="UID" style="width:100%;padding:8px;margin:5px 0;">
            <input id="pass" type="password" placeholder="Password" style="width:100%;padding:8px;margin:5px 0;">
            <button onclick="login()" style="width:100%;padding:10px;background:#FFD700;border:none;font-weight:bold;">LOGIN</button>
            <div id="loginStatus"></div>
        </div>
    </div>

    <script>
        // FIREBASE & STATE (Same as original)
        const firebaseConfig = {
            apiKey: "AIzaSyA-KabHNxU7PmQ3sARjqY7XrZ7LI5rSI8E",
            authDomain: "funtop-453ec.firebaseapp.com",
            databaseURL: "https://funtop-453ec-default-rtdb.firebaseio.com",
            projectId: "funtop-453ec",
            appId: "1:711635468186:web:3a8170c59cf9daa8c34423"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();
        const timerDoc = db.collection("settings").doc("timer");

        const state = {
            uid: null, coins: 0, timer: 60, betting: false, spinning: false,
            bets: Array(10).fill(0), betHistory: [], selectedAmount: 10,
            sessionToken: null, lastResultHandled: null
        };

        // --- ALL ORIGINAL FUNCTIONS KEPT UNTOUCHED ---
        
        timerDoc.onSnapshot((snap) => {
            if (!snap.exists) return;
            const data = snap.data();
            if (data.status === "RESULT" && !state.spinning && data.result !== undefined) {
                if(state.lastResultHandled !== data.timerStartTime?.toMillis()) {
                    state.lastResultHandled = data.timerStartTime?.toMillis();
                    START_SPIN_ANIMATION(data.result);
                }
            }
            if (data.timerStartTime) {
                const newTime = data.timerStartTime.toMillis();
                if (this.oldTime !== newTime) {
                    this.oldTime = newTime;
                    RESET_ROUND_LOCALLY();
                    startSyncTimer(newTime);
                }
            }
        });

        function startSyncTimer(serverStart) {
            clearInterval(window.timerInterval);
            window.timerInterval = setInterval(() => {
                let left = 60 - Math.floor((Date.now() - serverStart) / 1000);
                let display = left > 0 ? left : 0;
                document.getElementById("time").innerText = display;
                state.timer = display;
                if (left <= 15) state.betting = false;
                if (left === 8 && !state.spinStarted) calculateResult();
                if (left <= -5) triggerNewRound();
            }, 1000);
        }

        async function triggerNewRound() {
            await timerDoc.set({ timerStartTime: firebase.firestore.FieldValue.serverTimestamp(), status: "BET", bets: {} }, { merge: true });
        }

        async function calculateResult() {
            state.spinStarted = true;
            const snap = await timerDoc.get();
            const d = snap.data();
            let bets = d.bets || {};
            let minBet = []; let minAmt = Infinity;
            for (let i = 0; i < 10; i++) {
                let amt = bets[i] || 0;
                if (amt < minAmt) { minAmt = amt; minBet = [i]; } 
                else if (amt === minAmt) { minBet.push(i); }
            }
            let res = minBet[Math.floor(Math.random() * minBet.length)];
            await timerDoc.update({ status: "RESULT", result: res });
        }

        function START_SPIN_ANIMATION(win) {
            state.spinning = true;
            document.getElementById('slider').style.transition = "transform 8s cubic-bezier(0.1, 0, 0.1, 1)";
            document.getElementById('slider').style.transform = `translateX(${-win * 10}%)`;
            let start = null;
            function anim(now) {
                if (!start) start = now;
                let prog = Math.min((now - start) / 8000, 1);
                drawWheel(prog * 50); // Just for effect
                if (prog < 1) requestAnimationFrame(anim);
                else { state.spinning = false; document.getElementById('winner').textContent = win; checkWin(win); }
            }
            requestAnimationFrame(anim);
        }

        function checkWin(res) {
            if (state.bets[res] > 0) {
                let win = state.bets[res] * 9;
                state.coins += win;
                syncCoinsToDB(state.coins);
            }
            updateUI();
        }

        async function login(){
            const u = document.getElementById("uid").value;
            const p = document.getElementById("pass").value;
            const snap = await rtdb.ref("users/uid/"+u).once("value");
            if(snap.exists() && String(snap.val().password) === p) {
                state.uid = u; state.coins = snap.val().coins || 0;
                state.betting = true; document.getElementById("loginBlock").style.display="none";
                updateUI();
            }
        }

        function setupBettingUI() {
            const row = document.getElementById('betRow');
            for (let i = 0; i < 10; i++) {
                const box = document.createElement('div');
                box.className = 'number-box';
                box.innerHTML = `<div class="num">${i}</div><div class="bet-placed" id="bet-${i}">0</div>`;
                box.onclick = () => PLACE_BET(i);
                row.appendChild(box);
            }
        }

        function PLACE_BET(n) {
            if (state.timer > 15 && state.betting && state.coins >= state.selectedAmount) {
                state.coins -= state.selectedAmount;
                state.bets[n] += state.selectedAmount;
                state.betHistory.push({n, amt: state.selectedAmount});
                updateUI();
                syncCoinsToDB(state.coins);
                timerDoc.update({ [`bets.${n}`]: firebase.firestore.FieldValue.increment(state.selectedAmount) });
            }
        }

        function syncCoinsToDB(v) { if(state.uid) rtdb.ref("users/uid/"+state.uid).update({coins:v}); }
        function selectChip(a) { state.selectedAmount = a; }
        function RESET_ROUND_LOCALLY() { state.bets.fill(0); state.betHistory = []; state.spinStarted = false; updateUI(); }
        function updateUI() {
            document.getElementById('coins').textContent = state.coins;
            state.bets.forEach((v, i) => { document.getElementById(`bet-${i}`).textContent = v; });
        }

        const canvas = document.getElementById('wheel');
        const ctx = canvas.getContext('2d');
        function drawWheel(rot = 0) {
            ctx.clearRect(0, 0, 400, 400);
            ctx.save(); ctx.translate(200, 200); ctx.rotate(rot);
            for (let i = 0; i < 10; i++) {
                ctx.beginPath(); ctx.moveTo(0,0);
                ctx.arc(0,0, 180, i*Math.PI*2/10, (i+1)*Math.PI*2/10);
                ctx.fillStyle = i%2==0 ? '#ffd36a' : '#fff3b0';
                ctx.fill(); ctx.stroke();
                ctx.save(); ctx.rotate((i*Math.PI*2/10)+(Math.PI/10));
                ctx.fillStyle="#000"; ctx.fillText(i, 140, 0); ctx.restore();
            }
            ctx.restore();
        }

        window.onload = () => { setupBettingUI(); drawWheel(0); updateUI(); };
    </script>
</body>
</html>
